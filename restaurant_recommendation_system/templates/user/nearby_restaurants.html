{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="container-fluid mt-4">
    <!-- 頂部搜索欄 -->
    <div class="row mb-3">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-2">
                            <select id="county-select" class="form-select">
                                <option value="" selected>選擇縣市</option>
                                <!-- 縣市選項將由JS動態加載 -->
                            </select>
                        </div>
                        <div class="col-md-2">
                            <select id="town-select" class="form-select" disabled>
                                <option value="" selected>選擇鄉鎮區</option>
                                <!-- 鄉鎮區選項將由JS動態加載 -->
                            </select>
                        </div>
                        <div class="col-md-6">
                            <div class="input-group">
                                <input type="text" id="search-input" class="form-control" placeholder="搜尋餐廳類型（例如：咖啡、日式、火鍋）">
                                <button class="btn btn-primary" type="button" id="search-button">
                                    <i class="fas fa-search"></i> 搜尋
                                </button>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <button class="btn btn-outline-secondary w-100" id="use-current-location">
                                <i class="fas fa-location-arrow"></i> 使用當前位置
                            </button>
                        </div>
                    </div>
                    
                    <!-- 篩選選項 -->
                    <div class="row mt-3" id="filter-options">
                        <div class="col-12">
                            <button class="btn btn-sm btn-outline-secondary mb-2" id="toggle-filters">
                                <i class="fas fa-filter"></i> 顯示篩選選項
                            </button>
                            <div id="filter-panel" class="border rounded p-3" style="display: none;">
                                <div class="row g-2">
                                    <div class="col-md-3">
                                        <label class="form-label small">價格範圍</label>
                                        <select class="form-select form-select-sm" id="price-filter">
                                            <option value="">不限</option>
                                            <option value="1">NT$ (便宜)</option>
                                            <option value="2">NT$$ (適中)</option>
                                            <option value="3">NT$$$ (昂貴)</option>
                                            <option value="4">NT$$$$ (非常昂貴)</option>
                                        </select>
                                    </div>
                                    <div class="col-md-3">
                                        <label class="form-label small">最低評分</label>
                                        <select class="form-select form-select-sm" id="rating-filter">
                                            <option value="0">不限</option>
                                            <option value="3">3分以上</option>
                                            <option value="3.5">3.5分以上</option>
                                            <option value="4">4分以上</option>
                                            <option value="4.5">4.5分以上</option>
                                        </select>
                                    </div>
                                    <div class="col-md-3">
                                        <label class="form-label small">搜尋範圍</label>
                                        <select class="form-select form-select-sm" id="radius-filter">
                                            <option value="1000">1公里內</option>
                                            <option value="3000" selected>3公里內</option>
                                            <option value="5000">5公里內</option>
                                            <option value="10000">10公里內</option>
                                        </select>
                                    </div>
                                    <div class="col-md-3">
                                        <label class="form-label small">排序方式</label>
                                        <select class="form-select form-select-sm" id="sort-filter">
                                            <option value="rating">評分優先</option>
                                            <option value="distance" selected>距離優先</option>
                                            <option value="price">價格優先</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="mt-3 text-end">
                                    <button class="btn btn-sm btn-outline-secondary me-2" id="reset-filters">重置篩選</button>
                                    <button class="btn btn-sm btn-primary" id="apply-filters">套用篩選</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- 左側：地圖 -->
        <div class="col-md-7">
            <div class="card">
                <div class="card-body p-0 position-relative">
                    <div id="map" style="height: 650px; width: 100%;"></div>
                    <div class="position-absolute" style="top: 10px; right: 10px; z-index: 1000;">
                        <button id="search-map-area" class="btn btn-light btn-sm shadow">
                            <i class="fas fa-search"></i> 搜尋此區域
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 右側：餐廳列表 -->
        <div class="col-md-5">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">餐廳列表</h5>
                    <div id="location-info" class="text-muted small"></div>
                </div>
                <div class="card-body" style="max-height: 600px; overflow-y: auto;">
                    <div id="restaurants-list">
                        <!-- 餐廳列表將在這裡動態生成 -->
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    let map;
    let userLocation;
    let currentSearchLocation;  // 當前搜索位置
    let markers = [];
    let infoWindows = [];
    let placesService;
    let geocoder;
    let townData = [];  // 保存鄉鎮區數據
    let userMarker = null;  // 保存用戶位置標記的引用
    
    // 添加控制台警告處理
    const originalConsoleWarn = console.warn;
    console.warn = function() {
        // 過濾掉一些已知的Google Maps API警告
        const warningStr = Array.from(arguments).join(' ');
        if (warningStr.includes('permanently_closed is deprecated') || 
            warningStr.includes('google.maps.places.PlacesService is not available to new customers') ||
            warningStr.includes('google.maps.Marker is deprecated')) {
            // 忽略這些警告，或者可以將它們轉化為您自己的更友好的警告
            console.log('地圖API提示: Google Maps某些功能將在未來更新，目前仍可正常使用');
            return;
        }
        // 保留原始功能用於其他警告
        originalConsoleWarn.apply(console, arguments);
    };

    // 加載鄉鎮區數據
    function loadTownData() {
        fetch('/static/json/town.json')
            .then(response => response.json())
            .then(data => {
                townData = data;
                populateCountySelect();
            })
            .catch(error => {
                console.error('加載鄉鎮區數據失敗:', error);
                alert('無法加載縣市鄉鎮區數據，將使用默認搜索方式。');
            });
    }

    // 填充縣市選擇框
    function populateCountySelect() {
        const countySelect = document.getElementById('county-select');
        
        // 獲取不重複的縣市列表
        const counties = [...new Set(townData.map(item => item.CountyName))];
        
        // 按照字母順序排序
        counties.sort();
        
        // 添加縣市選項
        counties.forEach(county => {
            const option = document.createElement('option');
            option.value = county;
            option.textContent = county;
            countySelect.appendChild(option);
        });
    }

    // 填充鄉鎮區選擇框
    function populateTownSelect(countyName) {
        const townSelect = document.getElementById('town-select');
        
        // 清空現有選項
        townSelect.innerHTML = '<option value="" selected>選擇鄉鎮區</option>';
        
        // 獲取所選縣市的鄉鎮區
        const towns = townData
            .filter(item => item.CountyName === countyName)
            .map(item => item.TownName);
        
        // 按照字母順序排序
        towns.sort();
        
        // 添加鄉鎮區選項
        towns.forEach(town => {
            const option = document.createElement('option');
            option.value = town;
            option.textContent = town;
            townSelect.appendChild(option);
        });
        
        // 啟用鄉鎮區選擇框
        townSelect.disabled = false;
    }

    // 根據縣市和鄉鎮區獲取經緯度
    function getLocationFromTownData(countyName, townName) {
        const townInfo = townData.find(item => 
            item.CountyName === countyName && item.TownName === townName
        );
        
        if (townInfo) {
            return {
                lat: townInfo.latitude,
                lng: townInfo.longitude
            };
        }
        
        return null;
    }

    function initMap() {
        // 初始化地圖
        map = new google.maps.Map(document.getElementById('map'), {
            center: { lat: 23.69781, lng: 120.96051 },  // 台灣中心點
            zoom: 8
        });

        // 初始化地理編碼器
        geocoder = new google.maps.Geocoder();

        // 初始化 Places 服務
        placesService = new google.maps.places.PlacesService(map);

        // 處理可能的API警告和過時提示
        console.log('地圖API已初始化完成，某些API功能可能在未來版本中更新，但目前仍可正常使用');
        
        // 加載鄉鎮區數據
        loadTownData();
        
        // 初始隱藏搜尋此區域按鈕
        document.getElementById('search-map-area').style.display = 'none';
        
        // 為搜尋此區域按鈕添加點擊事件
        document.getElementById('search-map-area').addEventListener('click', function() {
            searchCurrentMapArea();
        });
        
        // 為地圖添加拖拽完成事件
        map.addListener('dragend', function() {
            // 顯示搜尋此區域按鈕
            document.getElementById('search-map-area').style.display = 'block';
        });
        
        // 為地圖添加縮放完成事件
        map.addListener('zoom_changed', function() {
            // 顯示搜尋此區域按鈕
            document.getElementById('search-map-area').style.display = 'block';
        });

        // 獲取用戶位置
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(
                function(position) {
                    userLocation = {
                        lat: position.coords.latitude,
                        lng: position.coords.longitude
                    };
                    
                    currentSearchLocation = userLocation;  // 設置當前搜索位置
                    
                    map.setCenter(userLocation);
                    map.setZoom(15);

                    // 添加用戶位置標記 - 不需要清除其他標記，因為剛初始化
                    userMarker = new google.maps.Marker({
                        position: userLocation,
                        map: map,
                        title: '您的位置',
                        icon: {
                            url: "http://maps.google.com/mapfiles/ms/icons/blue-dot.png",
                            scaledSize: new google.maps.Size(32, 32)
                        },
                        zIndex: 999 // 確保用戶標記顯示在最前面
                    });

                    // 獲取位置信息
                    reverseGeocode(userLocation);

                    // 初始搜索
                    searchNearbyRestaurants('restaurant');
                },
                function(error) {
                    alert('無法獲取您的位置，請確保已允許位置訪問權限。');
                }
            );
        } else {
            alert('您的瀏覽器不支持地理位置功能。');
        }

        // 縣市選擇事件
        document.getElementById('county-select').addEventListener('change', function() {
            const selectedCounty = this.value;
            if (selectedCounty) {
                // 填充鄉鎮區選擇框
                populateTownSelect(selectedCounty);
                
                // 清空鄉鎮區選擇
                document.getElementById('town-select').value = '';
                
                // 隱藏搜尋此區域按鈕
                document.getElementById('search-map-area').style.display = 'none';
                
                // 定位到縣市
                geocodeCounty(selectedCounty);
            } else {
                // 禁用鄉鎮區選擇框
                const townSelect = document.getElementById('town-select');
                townSelect.innerHTML = '<option value="" selected>選擇鄉鎮區</option>';
                townSelect.disabled = true;
            }
        });

        // 鄉鎮區選擇事件
        document.getElementById('town-select').addEventListener('change', function() {
            const selectedTown = this.value;
            const selectedCounty = document.getElementById('county-select').value;
            
            if (selectedTown && selectedCounty) {
                // 隱藏搜尋此區域按鈕
                document.getElementById('search-map-area').style.display = 'none';
                
                // 使用town.json中的經緯度
                const location = getLocationFromTownData(selectedCounty, selectedTown);
                
                if (location) {
                    currentSearchLocation = location;
                    map.setCenter(location);
                    map.setZoom(15);  // 鄉鎮區層級的縮放
                    
                    // 更新位置信息
                    document.getElementById('location-info').textContent = `當前位置: ${selectedCounty} ${selectedTown}`;
                    
                    // 使用選定的位置搜索
                    searchNearbyRestaurants(document.getElementById('search-input').value.trim() || 'restaurant');
                } else {
                    // 如果在town.json中找不到，則使用地理編碼API
                    geocodeTown(selectedCounty, selectedTown);
                }
            }
        });

        // 使用當前位置按鈕
        document.getElementById('use-current-location').addEventListener('click', function() {
            if (userLocation) {
                document.getElementById('county-select').value = '';
                document.getElementById('town-select').value = '';
                document.getElementById('town-select').disabled = true;
                
                // 隱藏搜尋此區域按鈕
                document.getElementById('search-map-area').style.display = 'none';
                
                currentSearchLocation = userLocation;
                map.setCenter(userLocation);
                map.setZoom(15);
                
                // 添加用戶位置標記
                clearMarkers(); // 先清除所有餐廳標記
                
                // 如果已有用戶標記，先移除
                if (userMarker) {
                    userMarker.setMap(null);
                }
                
                // 創建新的用戶標記
                userMarker = new google.maps.Marker({
                    position: userLocation,
                    map: map,
                    title: '您的位置',
                    icon: {
                        url: "http://maps.google.com/mapfiles/ms/icons/blue-dot.png",
                        scaledSize: new google.maps.Size(32, 32)
                    },
                    zIndex: 999 // 確保用戶標記顯示在最前面
                });
                
                reverseGeocode(userLocation);
                searchNearbyRestaurants(document.getElementById('search-input').value.trim() || 'restaurant');
            } else {
                alert('無法獲取當前位置，請確保已允許位置訪問權限。');
            }
        });
    }

    // 地理編碼 - 將縣市名稱轉換為經緯度
    function geocodeCounty(countyName) {
        geocoder.geocode({ 'address': countyName + ', 台灣' }, function(results, status) {
            if (status === 'OK' && results[0]) {
                const location = results[0].geometry.location;
                currentSearchLocation = {
                    lat: location.lat(),
                    lng: location.lng()
                };
                
                map.setCenter(currentSearchLocation);
                map.setZoom(12);  // 縣市層級的縮放
                
                // 更新位置信息
                const latLngText = `${currentSearchLocation.lat.toFixed(6)}°N, ${currentSearchLocation.lng.toFixed(6)}°E`;
                document.getElementById('location-info').innerHTML = `當前位置: ${countyName}<br><small>${latLngText}</small>`;
                
                // 使用選定的位置搜索
                searchNearbyRestaurants(document.getElementById('search-input').value.trim() || 'restaurant');
            } else {
                alert('無法找到該位置，請嘗試其他縣市。');
                console.error('Geocode error: ' + status);
            }
        });
    }

    // 地理編碼 - 將鄉鎮區名稱轉換為經緯度
    function geocodeTown(countyName, townName) {
        geocoder.geocode({ 'address': `${townName}, ${countyName}, 台灣` }, function(results, status) {
            if (status === 'OK' && results[0]) {
                const location = results[0].geometry.location;
                currentSearchLocation = {
                    lat: location.lat(),
                    lng: location.lng()
                };
                
                map.setCenter(currentSearchLocation);
                map.setZoom(15);  // 鄉鎮區層級的縮放
                
                // 更新位置信息
                const latLngText = `${currentSearchLocation.lat.toFixed(6)}°N, ${currentSearchLocation.lng.toFixed(6)}°E`;
                document.getElementById('location-info').innerHTML = `當前位置: ${countyName} ${townName}<br><small>${latLngText}</small>`;
                
                // 使用選定的位置搜索
                searchNearbyRestaurants(document.getElementById('search-input').value.trim() || 'restaurant');
            } else {
                alert('無法找到該位置，請嘗試其他鄉鎮區。');
                console.error('Geocode error: ' + status);
            }
        });
    }

    // 反向地理編碼 - 從經緯度獲取地址信息
    function reverseGeocode(location) {
        geocoder.geocode({ 'location': location }, function(results, status) {
            if (status === 'OK') {
                if (results[0]) {
                    // 從結果中提取城市和區域名稱
                    let countyName = '';
                    let townName = '';
                    
                    results[0].address_components.forEach(component => {
                        if (component.types.includes('administrative_area_level_1')) {
                            countyName = component.long_name;
                        }
                        if (component.types.includes('locality') || 
                            component.types.includes('administrative_area_level_3')) {
                            townName = component.long_name;
                        }
                    });
                    
                    // 嘗試匹配到town.json中的縣市和鄉鎮區
                    const matchedTown = townData.find(item => 
                        (item.CountyName === countyName || item.CountyName.replace('臺', '台') === countyName) && 
                        (item.TownName === townName || item.TownName.replace('臺', '台') === townName)
                    );
                    
                    // 顯示座標信息 - Google Maps格式
                    const latLngText = `${location.lat.toFixed(6)}°N, ${location.lng.toFixed(6)}°E`;
                    
                    if (matchedTown) {
                        // 如果在town.json中找到匹配，更新UI
                        document.getElementById('county-select').value = matchedTown.CountyName;
                        populateTownSelect(matchedTown.CountyName);
                        document.getElementById('town-select').value = matchedTown.TownName;
                        document.getElementById('location-info').innerHTML = `當前位置: ${matchedTown.CountyName} ${matchedTown.TownName}<br><small>${latLngText}</small>`;
                    } else {
                        // 如果未找到匹配，只顯示地址
                        const formattedAddress = results[0].formatted_address || '';
                        document.getElementById('location-info').innerHTML = `當前位置: ${formattedAddress}<br><small>${latLngText}</small>`;
                    }
                }
            } else {
                console.error('Reverse geocode error: ' + status);
                document.getElementById('location-info').innerHTML = `未知位置<br><small>${location.lat.toFixed(6)}°N, ${location.lng.toFixed(6)}°E</small>`;
            }
        });
    }

    function searchNearbyRestaurants(keyword = 'restaurant') {
        // 清除現有餐廳標記
        clearMarkers();
        
        // 顯示加載信息
        const restaurantsList = document.getElementById('restaurants-list');
        restaurantsList.innerHTML = '<div class="text-center p-3"><div class="spinner-border text-primary" role="status"></div><p class="mt-2">正在搜索餐廳...</p></div>';
        
        // 確保有當前搜索位置
        if (!currentSearchLocation) {
            currentSearchLocation = map.getCenter();
        }
        
        // 確保用戶位置標記在地圖上可見（如果存在）
        if (userLocation && userMarker) {
            userMarker.setMap(map);
        }
        
        // 獲取篩選條件
        const priceFilter = document.getElementById('price-filter').value;
        const ratingFilter = parseFloat(document.getElementById('rating-filter').value);
        const radiusFilter = parseInt(document.getElementById('radius-filter').value);
        const sortFilter = document.getElementById('sort-filter').value;
        
        try {
            // 如果有關鍵字，則使用textSearch而不是nearbySearch
            if (keyword && keyword !== 'restaurant') {
                // 使用 textSearch 搜索
                placesService.textSearch(
                    {
                        location: currentSearchLocation,
                        radius: radiusFilter,
                        query: keyword + ' restaurant'
                    }, 
                    function(results, status) {
                        handleSearchResults(results, status, priceFilter, ratingFilter, sortFilter);
                    }
                );
            } else {
                // 使用 nearbySearch 搜索
                // 如果距離優先，使用rankBy=DISTANCE參數
                if (sortFilter === 'distance') {
                    placesService.nearbySearch(
                        {
                            location: currentSearchLocation,
                            rankBy: google.maps.places.RankBy.DISTANCE,
                            type: 'restaurant'
                        }, 
                        function(results, status) {
                            handleSearchResults(results, status, priceFilter, ratingFilter, sortFilter);
                        }
                    );
                } else {
                    // 否則使用半徑參數
                    placesService.nearbySearch(
                        {
                            location: currentSearchLocation,
                            radius: radiusFilter,
                            type: 'restaurant'
                        }, 
                        function(results, status) {
                            handleSearchResults(results, status, priceFilter, ratingFilter, sortFilter);
                        }
                    );
                }
            }
        } catch (error) {
            console.error('搜索過程中發生錯誤:', error);
            restaurantsList.innerHTML = '<div class="alert alert-danger">搜索過程中發生錯誤，請稍後再試。</div>';
        }
    }

    function handleSearchResults(results, status, priceFilter, ratingFilter, sortFilter) {
        console.log('搜索狀態:', status);  // 調試信息
        console.log('搜索結果:', results);  // 調試信息
        
        const restaurantsList = document.getElementById('restaurants-list');

        if (status === google.maps.places.PlacesServiceStatus.OK) {
            // 應用篩選
            let filteredResults = results;
            
            // 計算每個結果到當前位置的距離（用於textSearch結果排序）
            if (sortFilter === 'distance' && currentSearchLocation) {
                filteredResults.forEach(place => {
                    const placeLocation = place.geometry.location;
                    const distance = google.maps.geometry.spherical.computeDistanceBetween(
                        new google.maps.LatLng(currentSearchLocation.lat, currentSearchLocation.lng),
                        placeLocation
                    );
                    place.distance = distance;
                });
                
                // 按距離排序
                filteredResults.sort((a, b) => (a.distance || 0) - (b.distance || 0));
            }
            
            // 應用價格篩選
            if (priceFilter) {
                filteredResults = filteredResults.filter(place => place.price_level === parseInt(priceFilter));
            }
            
            // 應用評分篩選
            if (ratingFilter > 0) {
                filteredResults = filteredResults.filter(place => place.rating >= ratingFilter);
            }
            
            // 應用排序 - 如果使用rankBy=DISTANCE，結果已經按距離排序
            if (sortFilter === 'rating') {
                filteredResults.sort((a, b) => (b.rating || 0) - (a.rating || 0));
            } else if (sortFilter === 'price') {
                filteredResults.sort((a, b) => (a.price_level || 0) - (b.price_level || 0));
            }
            // 距離排序在API返回結果中已經考慮，不需額外排序
            
            // 檢查篩選後是否有結果
            if (filteredResults.length === 0) {
                restaurantsList.innerHTML = '<div class="alert alert-warning">篩選後沒有符合條件的餐廳，請嘗試放寬篩選條件。</div>';
                return;
            }
            
            // 只顯示前10個結果
            const topResults = filteredResults.slice(0, 10);
            // 獲取每個餐廳的詳細信息
            fetchRestaurantDetails(topResults);
        } else if (status === google.maps.places.PlacesServiceStatus.ZERO_RESULTS) {
            restaurantsList.innerHTML = '<div class="alert alert-warning">沒有找到符合條件的餐廳，請嘗試其他關鍵字或位置。</div>';
        } else {
            restaurantsList.innerHTML = '<div class="alert alert-danger">搜索時發生錯誤，請稍後再試。</div>';
            console.error('Places API 錯誤:', status);
        }
    }

    function clearMarkers() {
        markers.forEach(marker => marker.setMap(null));
        markers = [];
        infoWindows = [];
        
        // 不清除用戶位置標記
    }

    // 獲取餐廳詳細信息
    function fetchRestaurantDetails(restaurants) {
        const restaurantsList = document.getElementById('restaurants-list');
        restaurantsList.innerHTML = '<div class="text-center p-3"><div class="spinner-border text-primary" role="status"></div><p class="mt-2">正在加載餐廳詳細信息...</p></div>';
        
        let completedRequests = 0;
        const detailedRestaurants = [];
        
        restaurants.forEach((restaurant, index) => {
            // 創建標記
            const marker = new google.maps.Marker({
                position: restaurant.geometry.location,
                map: map,
                title: restaurant.name,
                icon: {
                    url: getMarkerColor(restaurant.rating),
                    scaledSize: new google.maps.Size(24, 24) // 縮小餐廳標記大小
                }
            });
            markers.push(marker);
            
            // 獲取詳細信息
            placesService.getDetails(
                {
                    placeId: restaurant.place_id,
                    fields: ['name', 'rating', 'formatted_address', 'website', 'formatted_phone_number', 'types', 'price_level', 'photos', 'opening_hours']
                },
                function(place, status) {
                    completedRequests++;
                    
                    if (status === google.maps.places.PlacesServiceStatus.OK) {
                        // 合併基本信息和詳細信息
                        const detailedRestaurant = {
                            ...restaurant,
                            ...place,
                            index: index // 保存索引，用於顯示地圖標記
                        };
                        detailedRestaurants.push(detailedRestaurant);
                        
                        // 更新信息窗口內容
                        const infoWindow = new google.maps.InfoWindow({
                            content: generateInfoWindowContent(detailedRestaurant)
                        });
                        infoWindows.push(infoWindow);
                        
                        // 添加點擊事件
                        marker.addListener('click', function() {
                            infoWindows.forEach(window => window.close());
                            infoWindow.open(map, marker);
                        });
                    }
                    
                    // 當所有請求完成後，顯示結果
                    if (completedRequests === restaurants.length) {
                        displayDetailedRestaurants(detailedRestaurants);
                    }
                }
            );
        });
    }

    function getMarkerColor(rating) {
        // 統一使用自定義餐廳圖標
        return '/static/images/r.png';
    }

    function getRatingColor(rating) {
        if (!rating) return 'text-danger';
        if (rating >= 4.5) return 'text-success';
        if (rating >= 4.0) return 'text-primary';
        if (rating >= 3.5) return 'text-warning';
        return 'text-danger';
    }

    // 生成信息窗口內容
    function generateInfoWindowContent(restaurant) {
        const priceLevel = getPriceLevelText(restaurant.price_level);
        const typesText = getRestaurantTypes(restaurant.types);
        const photoUrl = restaurant.photos && restaurant.photos.length > 0 ? 
            restaurant.photos[0].getUrl({ maxWidth: 200, maxHeight: 200 }) : '';
        
        // 格式化距離信息
        let distanceText = '';
        if (restaurant.distance !== undefined) {
            distanceText = restaurant.distance < 1000 ? 
                `${Math.round(restaurant.distance)} 公尺` : 
                `${(restaurant.distance / 1000).toFixed(1)} 公里`;
        }
        
        return `
            <div style="max-width: 300px;">
                ${photoUrl ? `<img src="${photoUrl}" style="width: 100%; height: auto; margin-bottom: 10px;" alt="${restaurant.name}">` : ''}
                <h5>${restaurant.name}</h5>
                <p>
                    <strong>評分:</strong> <span class="${getRatingColor(restaurant.rating)}">${restaurant.rating || '無'}</span><br>
                    ${distanceText ? `<strong>距離:</strong> ${distanceText}<br>` : ''}
                    <strong>價格:</strong> ${priceLevel}<br>
                    <strong>類型:</strong> ${typesText}<br>
                    <strong>地址:</strong> ${restaurant.formatted_address || restaurant.vicinity || '無'}<br>
                    ${restaurant.formatted_phone_number ? `<strong>電話:</strong> ${restaurant.formatted_phone_number}<br>` : ''}
                    ${restaurant.website ? `<strong>網站:</strong> <a href="${restaurant.website}" target="_blank">點擊訪問</a><br>` : ''}
                </p>
            </div>
        `;
    }

    // 顯示詳細餐廳信息
    function displayDetailedRestaurants(restaurants) {
        const restaurantsList = document.getElementById('restaurants-list');
        restaurantsList.innerHTML = '';
        
        // 獲取排序方式
        const sortFilter = document.getElementById('sort-filter').value;
        
        // 根據排序方式排序
        if (sortFilter === 'rating') {
            restaurants.sort((a, b) => (b.rating || 0) - (a.rating || 0));
        } else if (sortFilter === 'price') {
            restaurants.sort((a, b) => (a.price_level || 0) - (b.price_level || 0));
        } else if (sortFilter === 'distance' && restaurants[0].distance !== undefined) {
            restaurants.sort((a, b) => (a.distance || 0) - (b.distance || 0));
        }
        
        restaurants.forEach((restaurant) => {
            const priceLevel = getPriceLevelText(restaurant.price_level);
            const typesText = getRestaurantTypes(restaurant.types);
            const photoUrl = restaurant.photos && restaurant.photos.length > 0 ? 
                restaurant.photos[0].getUrl({ maxWidth: 300, maxHeight: 200 }) : '';
            
            // 計算並格式化距離信息
            let distanceText = '';
            if (restaurant.distance !== undefined) {
                distanceText = restaurant.distance < 1000 ? 
                    `${Math.round(restaurant.distance)} 公尺` : 
                    `${(restaurant.distance / 1000).toFixed(1)} 公里`;
            }
            
            const restaurantElement = document.createElement('div');
            restaurantElement.className = 'card mb-3';
            const ratingColor = getRatingColor(restaurant.rating);
            
            restaurantElement.innerHTML = `
                <div class="card-body">
                    ${photoUrl ? `<img src="${photoUrl}" class="img-fluid mb-2" style="width: 100%; object-fit: cover; height: 150px;" alt="${restaurant.name}">` : ''}
                    <h5 class="card-title">${restaurant.name}</h5>
                    <p class="card-text">
                        <strong>評分:</strong> <span class="${ratingColor}">${restaurant.rating || '無'}</span><br>
                        ${distanceText ? `<strong>距離:</strong> ${distanceText}<br>` : ''}
                        <strong>價格:</strong> ${priceLevel}<br>
                        <strong>類型:</strong> ${typesText}<br>
                        <strong>地址:</strong> ${restaurant.formatted_address || restaurant.vicinity || '無'}<br>
                        ${restaurant.formatted_phone_number ? `<strong>電話:</strong> ${restaurant.formatted_phone_number}<br>` : ''}
                        ${restaurant.website ? `<strong>網站:</strong> <a href="${restaurant.website}" target="_blank">點擊訪問</a><br>` : ''}
                    </p>
                    <div class="mt-2">
                        <button class="btn btn-primary btn-sm" onclick="showOnMap(${restaurant.index})">
                            在地圖上顯示
                        </button>
                        ${restaurant.website ? `<a href="${restaurant.website}" target="_blank" class="btn btn-outline-secondary btn-sm">官方網站</a>` : ''}
                    </div>
                </div>
            `;
            restaurantsList.appendChild(restaurantElement);
        });
    }

    // 獲取價格等級文字描述
    function getPriceLevelText(priceLevel) {
        if (priceLevel === undefined || priceLevel === null) return '無價格信息';
        
        const priceLevels = ['免費', '便宜', '適中', '昂貴', '非常昂貴'];
        const priceSymbols = ['', 'NT$', 'NT$$', 'NT$$$', 'NT$$$$'];
        
        if (priceLevel >= 0 && priceLevel < priceLevels.length) {
            return `${priceSymbols[priceLevel]} (${priceLevels[priceLevel]})`;
        }
        
        return '無價格信息';
    }

    // 獲取餐廳類型
    function getRestaurantTypes(types) {
        if (!types || types.length === 0) return '無類型信息';
        
        // 過濾掉一些通用類型
        const filteredTypes = types.filter(type => 
            !['point_of_interest', 'establishment', 'food', 'restaurant'].includes(type)
        );
        
        // 美化類型名稱
        const typeMap = {
            'cafe': '咖啡廳',
            'bakery': '麵包店',
            'bar': '酒吧',
            'meal_takeaway': '外帶餐廳',
            'meal_delivery': '外送餐廳',
            'japanese_restaurant': '日本料理',
            'chinese_restaurant': '中式料理',
            'italian_restaurant': '義式料理',
            'american_restaurant': '美式料理',
            'korean_restaurant': '韓式料理',
            'thai_restaurant': '泰式料理',
            'indian_restaurant': '印度料理',
            'seafood_restaurant': '海鮮餐廳',
            'vegetarian_restaurant': '素食餐廳',
            'fast_food_restaurant': '速食餐廳',
            'fine_dining_restaurant': '高級餐廳',
            // 可以根據需要添加更多類型
        };
        
        // 轉換類型名稱
        const prettyTypes = filteredTypes.map(type => {
            return typeMap[type] || type.replace(/_/g, ' ');
        });
        
        return prettyTypes.length > 0 ? prettyTypes.join(', ') : '一般餐廳';
    }

    function showOnMap(index) {
        const marker = markers[index];
        const infoWindow = infoWindows[index];
        
        map.panTo(marker.getPosition());
        map.setZoom(17);
        
        infoWindows.forEach(window => window.close());
        infoWindow.open(map, marker);
    }

    // 搜索按鈕點擊事件
    document.getElementById('search-button').addEventListener('click', function() {
        const keyword = document.getElementById('search-input').value.trim();
        if (!keyword) {
            alert('請輸入搜索關鍵字');
            return;
        }
        searchNearbyRestaurants(keyword);
    });

    // 搜索輸入框回車事件
    document.getElementById('search-input').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            const keyword = this.value.trim();
            if (!keyword) {
                alert('請輸入搜索關鍵字');
                return;
            }
            searchNearbyRestaurants(keyword);
        }
    });
    
    // 篩選面板顯示/隱藏
    document.getElementById('toggle-filters').addEventListener('click', function() {
        const filterPanel = document.getElementById('filter-panel');
        const isVisible = filterPanel.style.display !== 'none';
        
        filterPanel.style.display = isVisible ? 'none' : 'block';
        this.innerHTML = isVisible ? 
            '<i class="fas fa-filter"></i> 顯示篩選選項' : 
            '<i class="fas fa-filter"></i> 隱藏篩選選項';
    });
    
    // 重置篩選按鈕
    document.getElementById('reset-filters').addEventListener('click', function() {
        document.getElementById('price-filter').value = '';
        document.getElementById('rating-filter').value = '0';
        document.getElementById('radius-filter').value = '3000';
        document.getElementById('sort-filter').value = 'distance';
    });
    
    // 套用篩選按鈕
    document.getElementById('apply-filters').addEventListener('click', function() {
        const keyword = document.getElementById('search-input').value.trim() || 'restaurant';
        searchNearbyRestaurants(keyword);
    });
    
    // 搜尋當前地圖區域
    function searchCurrentMapArea() {
        // 獲取地圖當前中心點
        const mapCenter = map.getCenter();
        currentSearchLocation = {
            lat: mapCenter.lat(),
            lng: mapCenter.lng()
        };
        
        // 清除縣市和鄉鎮區選擇
        document.getElementById('county-select').value = '';
        document.getElementById('town-select').value = '';
        document.getElementById('town-select').disabled = true;
        
        // 更新位置信息
        const latLngText = `${currentSearchLocation.lat.toFixed(6)}°N, ${currentSearchLocation.lng.toFixed(6)}°E`;
        document.getElementById('location-info').innerHTML = `當前位置: 地圖中心點<br><small>${latLngText}</small>`;
        
        // 確保用戶位置標記在地圖上可見（如果存在）
        if (userLocation && userMarker) {
            userMarker.setMap(map);
        }
        
        // 執行搜尋
        const keyword = document.getElementById('search-input').value.trim() || 'restaurant';
        searchNearbyRestaurants(keyword);
        
        // 嘗試獲取地圖中心點的地址信息
        reverseGeocodeMapCenter(currentSearchLocation);
    }
    
    // 反向地理編碼地圖中心點
    function reverseGeocodeMapCenter(location) {
        geocoder.geocode({ 'location': location }, function(results, status) {
            if (status === 'OK' && results[0]) {
                // 更新位置信息為地址名稱
                const formattedAddress = results[0].formatted_address || '';
                const latLngText = `${location.lat.toFixed(6)}°N, ${location.lng.toFixed(6)}°E`;
                document.getElementById('location-info').innerHTML = `當前位置: ${formattedAddress}<br><small>${latLngText}</small>`;
                
                // 從結果中提取城市和區域名稱
                let countyName = '';
                let townName = '';
                
                results[0].address_components.forEach(component => {
                    if (component.types.includes('administrative_area_level_1')) {
                        countyName = component.long_name;
                    }
                    if (component.types.includes('locality') || 
                        component.types.includes('administrative_area_level_3')) {
                        townName = component.long_name;
                    }
                });
                
                // 如果能夠識別到縣市和鄉鎮區，更新選擇框
                if (countyName && townData.some(item => item.CountyName === countyName || 
                                                        item.CountyName.replace('臺', '台') === countyName)) {
                    // 更新縣市選擇框
                    document.getElementById('county-select').value = countyName;
                    
                    // 更新鄉鎮區選擇框
                    populateTownSelect(countyName);
                    if (townName) {
                        const matchingTowns = townData.filter(item => 
                            (item.CountyName === countyName || item.CountyName.replace('臺', '台') === countyName) && 
                            (item.TownName === townName || item.TownName.replace('臺', '台') === townName)
                        );
                        
                        if (matchingTowns.length > 0) {
                            document.getElementById('town-select').value = matchingTowns[0].TownName;
                        }
                    }
                }
            }
        });
    }
</script>

<!-- 動態加載 Google Maps API -->
<script>
    function loadGoogleMapsAPI() {
        const script = document.createElement('script');
        script.src = `https://maps.googleapis.com/maps/api/js?key={{ google_api_key }}&libraries=places,geocoding,geometry&callback=initMap&loading=async`;
        script.async = true;
        script.defer = true;
        document.head.appendChild(script);
    }
    
    // 頁面加載完成後載入API
    window.onload = loadGoogleMapsAPI;
</script>

{% endblock %}